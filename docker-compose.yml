version: '3'

services:

  postgres_db:
    image: postgres:14
    expose:
      - 5432
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - FASTAPI_DB_USER=bellias
      - FASTAPI_DB_PASS=pass123
      - FASTAPI_DB_NAME=reference_letters_data
      - KEYCLOAK_DB_USER=testkeycloakuser
      - KEYCLOAK_DB_PASS=testkeycloakpassword
      - KEYCLOAK_DB_NAME=testkeycloakdb
    healthcheck:
      test: [ "CMD", "pg_isready", "-q", "-d", "postgres", "-U", "postgres" ]
      timeout: 30s
      interval: 30s
      retries: 3
    volumes:
      - 'dj_postgres_data:/var/lib/postgresql/data/'
      - './ref_letters/assets/init_db:/docker-entrypoint-initdb.d/'
    restart:
      always

  keycloak_auth:
    image: quay.io/keycloak/keycloak:legacy
    environment:
      DB_VENDOR: POSTGRES
      DB_ADDR: postgres
      DB_DATABASE: testkeycloakdb
      DB_USER: testkeycloakuser
      DB_SCHEMA: public
      DB_PASSWORD: testkeycloakpassword
      KEYCLOAK_USER: keycloakuser
      KEYCLOAK_PASSWORD: keycloakpassword
    ports:
      - 8085:8080
    depends_on:
      - postgres_db
    restart:
      always

  fastapi:
    build:
      context: .
      dockerfile: fastapi.nonroot.Dockerfile
    # command: cp ref_letters/.env.example ref_letters/.env
    # command: uvicorn ref_letters.main:app --reload --workers 1 --host 0.0.0.0 --port 8000
    ports:
      - "8000:8000"
      - "80:80"
    volumes:
      - ./ref_letters:/usr/data/app
    env_file:
      - ref_letters/.env
    depends_on:
      - postgres_db
      - keycloak_auth

volumes:
  dj_postgres_data:
